<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
	<modelVersion>4.0.0</modelVersion>

	<parent>
		<groupId>no.stelvio.maven.poms</groupId>
		<artifactId>maven-root-pom</artifactId>
		<version>1.2.5</version>
	</parent>

	<groupId>no.stelvio.maven.poms</groupId>
	<artifactId>maven-service-gw-provisioning-orchestration-pom</artifactId>
	<version>1.0.0</version>
	<name>Maven service-gw provisioning orchestration POM</name>
	
	<properties>
		<serviceRegistryUpdaterPluginVersion>1.0.0</serviceRegistryUpdaterPluginVersion>
		<!-- Dependencies -->
		<dataPowerVer>1.10</dataPowerVer>
		<mavenEnforcerVer>1.0-beta-1</mavenEnforcerVer>
		<mavenPropertiesVer>1.3</mavenPropertiesVer>
		<deployKeys>${user.home}/deploy-keys/</deployKeys>
		<passwordVault>${user.home}/vault/</passwordVault>

		<!-- Configuration -->
		<datapower.domain>${datapower.gateway}-${env}</datapower.domain>
		<datapower.gateway>service-gw</datapower.gateway>		
		<datapower.xmlManager>default</datapower.xmlManager>
		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
		<registryFile>service-registry.xml</registryFile>
		<registryFolder>${project.build.directory}/regFolder/</registryFolder>
	</properties>

	<build>
		<outputDirectory>${project.build.directory}</outputDirectory>
		<resources>
			<resource>
				<directory>.</directory>
				<includes>
					<include>pom.xml</include>
				</includes>
			</resource>
		</resources>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-release-plugin</artifactId>
				<configuration>
					<tagBase>https://versjonskontroll.adeo.no/svn/stelvio/tags/int/maven/poms/maven-service-gw-provisioning-orchestration-pom</tagBase>
					<goals>deploy</goals>
				</configuration>
			</plugin>
		</plugins>
	</build>

	<profiles>
		<profile>
			<id>provision</id>
			<build>
				<plugins>

					<!-- Load properties files -->
					<plugin>
						<groupId>no.nav.maven.plugins</groupId>
						<artifactId>maven-properties-plugin</artifactId>
						<version>${mavenPropertiesVer}</version>
						<executions>
							<execution>
								<id>load-property-files</id>
								<phase>validate</phase>
								<goals>
									<goal>load-properties</goal>
								</goals>
								<configuration>
									<files>														
										<file>${deployKeys}/${envclass}/datapower.properties</file>
									</files>
								</configuration>
							</execution>
						</executions>
					</plugin>

					<!-- Verify that all required properties are set -->
					<plugin>
						<groupId>org.apache.maven.plugins</groupId>
						<artifactId>maven-enforcer-plugin</artifactId>
						<version>${mavenEnforcerVer}</version>
						<executions>
							<execution>
								<id>enforce-required-properties</id>
								<goals>
									<goal>enforce</goal>
								</goals>
								<phase>initialize</phase>
								<configuration>
									<rules>
										<requireProperty>
											<property>datapower.baseurl</property>
											<property>datapower.username</property>
											<property>datapower.password</property>
											<property>datapower.domain</property>
											<property>datapower.gateway</property>
											<property>datapower.xmlManager</property>
											<property>registryFile</property>
											<property>registryFolder</property>
											<property>env</property>
											<property>envclass</property>
										</requireProperty>
									</rules>
								</configuration>
							</execution>
						</executions>
					</plugin>		

					<plugin>
						<groupId>no.nav.maven.plugins</groupId>
						<artifactId>maven-datapower-plugin</artifactId>
						<version>${dataPowerVer}</version>
						<executions>
							<!-- Get the registry file from DataPower -->
							<execution>
								<id>get-registry-file</id>
								<phase>generate-sources</phase>
								<goals>
									<goal>getFile</goal>
								</goals>
								<configuration>
									<domain>${datapower.domain}</domain>
									<fileName>${registryFile}</fileName>
									<outputDir>${registryFolder}</outputDir>
								</configuration>
							</execution>
							<execution>
								<id>flush-document-cache</id>
								<phase>process-classes</phase>
								<goals>
									<goal>flushDocumentCache</goal>
								</goals>
								<configuration>
									<domain>${datapower.domain}</domain>
									<xmlManager>${datapower.xmlManager}</xmlManager>
								</configuration>
							</execution>
							<!-- Upload the newly updated registry file -->
							<execution>
								<id>import-registry-file</id>
								<phase>install</phase>
								<goals>
									<goal>importFiles</goal>
								</goals>
								<configuration>
									<domain>${datapower.domain}</domain>
									<importDir>${registryFolder}</importDir>
									<singleFiles>true</singleFiles>
								</configuration>
							</execution>
						</executions>
					</plugin>

					<!-- Update the registry file -->
					<plugin>
						<groupId>no.nav.maven.plugins</groupId>
						<artifactId>maven-service-registry-updater-plugin</artifactId>
						<version>${serviceRegistryUpdaterPluginVersion}</version>
						<executions>
							<execution>
								<id>generate-service-registry</id>
								<phase>compile</phase>
								<goals>
									<goal>generate-file</goal>
								</goals>
								<configuration>
									<apps>${apps}</apps><!-- should be input from hudson job formatted like "pselv, norg,Joark" -->
									<serviceRegistryFile>${registryFolder}${registryFile}</serviceRegistryFile>
									<baseUrl>http://env-config.adeo.no:8080/conf</baseUrl>
								</configuration>
							</execution>
						</executions>
					</plugin>
				</plugins>

			</build>
		</profile>
	</profiles>

	<scm>
		<connection>scm:svn:https://versjonskontroll.adeo.no/svn/stelvio/tags/int/maven/poms/maven-service-gw-provisioning-orchestration-pom/maven-service-gw-provisioning-orchestration-pom-1.0.0</connection>
		<developerConnection>scm:svn:https://versjonskontroll.adeo.no/svn/stelvio/tags/int/maven/poms/maven-service-gw-provisioning-orchestration-pom/maven-service-gw-provisioning-orchestration-pom-1.0.0</developerConnection>
	</scm>

</project>