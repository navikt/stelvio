<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<groupId>no.nav.datapower</groupId>
	<artifactId>deploy-util</artifactId>
	<version>1.0.0-SNAPSHOT</version>
	<name>Deploy util for Datapower application domains</name>

	<properties>
		<deployKeys>${user.home}/deploy-keys/</deployKeys>
		<esb-version>${esb-release-version}</esb-version>
	</properties>

	<dependencies>
		<dependency>
			<groupId>no.nav.maven.support</groupId>
			<artifactId>busconfiguration</artifactId>
			<version>${bus-configuration-version}</version>
		</dependency>
	</dependencies>

	<build>
		<outputDirectory>${project.build.directory}/datapower-config/${gateway-name}-${env}</outputDirectory>
		<resources>
			<resource>
				<directory>${project.build.directory}/dependency/${gateway-name}-jar</directory>
				<filtering>true</filtering>
			</resource>
			<!-- Copy files from bus environment -->
			<resource>
				<directory>${project.build.directory}/dependency/busconfiguration-jar/environments/${envclass}/datapower-cfg-${gateway-name}-files/</directory>
				<targetPath>files/</targetPath>
				<filtering>true</filtering>
			</resource>
			<resource>
				<directory>${project.build.directory}/dependency/busconfiguration-jar/environments/${envclass}/${env}/datapower-cfg-${gateway-name}-files/</directory>
				<targetPath>files/</targetPath>
				<filtering>true</filtering>
			</resource>
			<resource>
				<directory>${project.build.directory}/dependency/busconfiguration-jar/environments/${envclass}/datapower-cfg-${gateway-name}-env-extensions/</directory>
				<targetPath>extensions/</targetPath>
				<filtering>true</filtering>
			</resource>
			<!-- Copy files from key directory structure -->
			<resource>
				<directory>${deployKeys}/${envclass}/datapower-cfg-${gateway-name}-files/</directory>
				<targetPath>files/</targetPath>
			</resource>
			<resource>
				<directory>${deployKeys}/${envclass}/${env}/datapower-cfg-${gateway-name}-files/</directory>
				<targetPath>files/</targetPath>
			</resource>
		</resources>
		<testResources>
			<testResource>
				<directory>src/test/verifier</directory>
				<filtering>true</filtering>
			</testResource>
		</testResources>
		<plugins>
			<!-- Unpack bus release and configuration -->
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-dependency-plugin</artifactId>
				<version>2.0</version>
				<executions>
					<execution>
						<id>unpack-configuration</id>
						<phase>initialize</phase>
						<goals>
							<goal>unpack-dependencies</goal>
						</goals>
						<configuration>
							<excludeTransitive>true</excludeTransitive>
							<useSubDirectoryPerArtifact>true</useSubDirectoryPerArtifact>
							<stripVersion>true</stripVersion>
						</configuration>
					</execution>
				</executions>
			</plugin>
			<plugin>
				<groupId>no.nav.maven.plugins</groupId>
				<artifactId>maven-properties-plugin</artifactId>
				<version>1.1</version>
				<executions>
					<!-- Load properties from file -->
					<execution>
						<id>load-property-files</id>
						<phase>initialize</phase>
						<goals>
							<goal>load-properties</goal>
						</goals>
						<configuration>
							<files>
								<!-- Add properties from old properties file for backward compatibility -->
								<file>${project.build.directory}/dependency/busconfiguration-jar/environments/cfg-${gateway-name}-${env}.properties</file>

								<file>${project.build.directory}/dependency/busconfiguration-jar/environments/datapower-cfg-${gateway-name}.properties</file>
								<file>${project.build.directory}/dependency/busconfiguration-jar/environments/${envclass}/esb.properties</file>
								<file>${project.build.directory}/dependency/busconfiguration-jar/environments/${envclass}/${env}/esb.properties</file>
								<file>${project.build.directory}/dependency/busconfiguration-jar/environments/${envclass}/datapower.properties</file>
								<file>${project.build.directory}/dependency/busconfiguration-jar/environments/${envclass}/${env}/datapower.properties</file>
								<file>
									${project.build.directory}/dependency/busconfiguration-jar/environments/${envclass}/datapower-cfg-${gateway-name}.properties
								</file>
								<file>
									${project.build.directory}/dependency/busconfiguration-jar/environments/${envclass}/${env}/datapower-cfg-${gateway-name}.properties
								</file>
								<file>${deployKeys}/${envclass}/esb.properties</file>
								<file>${deployKeys}/${envclass}/${env}/esb.properties</file>
								<file>${deployKeys}/${envclass}/datapower.properties</file>
								<file>${deployKeys}/${envclass}/${env}/datapower.properties</file>
								<file>${deployKeys}/${envclass}/datapower-cfg-${gateway-name}.properties</file>
								<file>${deployKeys}/${envclass}/${env}/datapower-cfg-${gateway-name}.properties</file>
							</files>
						</configuration>
					</execution>
					<!-- Verify that there are no unresolved properties left in the configuration.xml file -->
					<execution>
						<id>verify-resource-filtering</id>
						<phase>test</phase>
						<goals>
							<goal>detect-unresolved-properties</goal>
						</goals>
						<configuration>
							<file>${project.build.directory}/datapower-config/${gateway-name}-${env}/configuration.xml</file>
						</configuration>
					</execution>
				</executions>
			</plugin>
			<!-- Verify that all required properties are set, once in validate-phase and once in initialize-phase -->
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-enforcer-plugin</artifactId>
				<version>1.0-beta-1</version>
				<executions>
					<execution>
						<id>enforce-required-properties-validate</id>
						<goals>
							<goal>enforce</goal>
						</goals>
						<phase>validate</phase>
						<configuration>
							<rules>
								<requireProperty>
									<property>gateway-name</property>
								</requireProperty>
								<requireProperty>
									<property>envclass</property>
								</requireProperty>
								<requireProperty>
									<property>env</property>
								</requireProperty>
							</rules>
						</configuration>
					</execution>
					<execution>
						<id>enforce-required-properties-initialize</id>
						<goals>
							<goal>enforce</goal>
						</goals>
						<phase>initialize</phase>
						<configuration>
							<rules>
								<requireProperty>
									<property>datapower.baseurl</property>
								</requireProperty>
								<requireProperty>
									<property>datapower.username</property>
								</requireProperty>
								<requireProperty>
									<property>datapower.password</property>
								</requireProperty>
								<requireProperty>
									<property>datapower.domain</property>
								</requireProperty>
							</rules>
						</configuration>
					</execution>
				</executions>
			</plugin>
			<!-- Verify that all required files are present -->
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-verifier-plugin</artifactId>
				<version>1.0-beta-1</version>
				<executions>
					<execution>
						<id>verify-required-files</id>
						<phase>test</phase>
						<goals>
							<goal>verify</goal>
						</goals>
						<configuration>
							<basedir>${project.build.directory}/datapower-config/${gateway-name}-${env}</basedir>
							<verificationFile>
								${project.build.directory}/datapower-config/${gateway-name}-${env}/test/verifier/required-files.xml
							</verificationFile>
						</configuration>
					</execution>
				</executions>
			</plugin>
			<!-- Invoke SOAP management interface on server -->
			<plugin>
				<groupId>no.nav.maven.plugins</groupId>
				<artifactId>maven-datapower-plugin</artifactId>
				<version>1.5</version>
				<executions>
					<execution>
						<id>importFiles</id>
						<phase>install</phase>
						<goals>
							<goal>importFiles</goal>
						</goals>
						<configuration>
							<domain>${datapower.domain}</domain>
							<importDir>${project.build.directory}/datapower-config/${gateway-name}-${env}/files</importDir>
						</configuration>
					</execution>
					<execution>
						<id>importConfig</id>
						<phase>install</phase>
						<goals>
							<goal>importConfig</goal>
						</goals>
						<configuration>
							<domain>${datapower.domain}</domain>
							<configFile>${project.build.directory}/datapower-config/${gateway-name}-${env}/configuration.xml</configFile>
							<extensionsDir>${build.outputDirectory}/extensions/</extensionsDir>
						</configuration>
					</execution>
					<execution>
						<id>saveConfig</id>
						<phase>install</phase>
						<goals>
							<goal>saveConfig</goal>
						</goals>
						<configuration>
							<domain>${datapower.domain}</domain>
						</configuration>
					</execution>
					<execution>
						<id>restartDomain</id>
						<phase>install</phase>
						<goals>
							<goal>restartDomain</goal>
						</goals>
						<configuration>
							<domain>${datapower.domain}</domain>
						</configuration>
					</execution>
				</executions>
			</plugin>
			<!-- Make sure packaging 'wsdl-interface' will be resolved -->
			<plugin>
				<groupId>no.nav.maven.plugins</groupId>
				<artifactId>maven-wsdl-export-plugin</artifactId>
				<version>1.3</version>
				<extensions>true</extensions>
			</plugin>
		</plugins>
	</build>

	<!-- Add dependencies dynamically based on the property 'gateway-name' -->
	<!-- This mechanism is suboptimal, and is a symptom of using Maven to define a deployscript for multiple artifacts -->
	<profiles>
		<profile>
			<id>secgw</id>
			<activation>
				<property>
					<name>gateway-name</name>
					<value>secgw</value>
				</property>
			</activation>
			<properties>
				<gateway-version>${esb-release-version}</gateway-version>
			</properties>
			<dependencies>
				<dependency>
					<artifactId>secgw</artifactId>
					<groupId>no.nav.datapower.cfg</groupId>
					<version>${gateway-version}</version>
				</dependency>
			</dependencies>
		</profile>
		<profile>
			<id>partner-gw</id>
			<activation>
				<property>
					<name>gateway-name</name>
					<value>partner-gw</value>
				</property>
			</activation>
			<properties>
				<gateway-version>${esb-release-version}</gateway-version>
			</properties>
			<dependencies>
				<dependency>
					<artifactId>partner-gw</artifactId>
					<groupId>no.nav.datapower.cfg</groupId>
					<version>${gateway-version}</version>
				</dependency>
			</dependencies>
		</profile>
		<profile>
			<id>nhn-gw</id>
			<activation>
				<property>
					<name>gateway-name</name>
					<value>nhn-gw</value>
				</property>
			</activation>
			<properties>
				<gateway-version>1.0.2</gateway-version>
			</properties>
			<dependencies>
				<dependency>
					<artifactId>nhn-gw</artifactId>
					<groupId>no.nav.datapower.cfg</groupId>
					<version>${gateway-version}</version>
				</dependency>
			</dependencies>
		</profile>
		<profile>
			<id>service-gateway</id>
			<activation>
				<property>
					<name>gateway-name</name>
					<value>service-gateway</value>
				</property>
			</activation>
			<properties>
				<gateway-version>1.0.0-SNAPSHOT</gateway-version>
			</properties>
			<dependencies>
				<dependency>
					<groupId>no.stelvio.int.poc</groupId>
					<artifactId>service-gateway</artifactId>
					<version>1.0.0-SNAPSHOT</version>
				</dependency>
			</dependencies>
		</profile>
	</profiles>

</project>
